var spawn = require('child_process').spawn;
var chalk = require('chalk');

function exec(fullCommand, options, callback) {
  var commandAndArgs = fullCommand.split(/\s+/);
  var command = commandAndArgs[0];
  var args = commandAndArgs.slice(1);

  if (typeof options === 'function') {
    callback = options;
    options = null;
  }

  options = options || {};

  callback = callback || options.callback;

  var prefix = (options.prefix || command) + ': ';
  if (options.color) prefix = chalk[options.color](prefix);

  var child = spawn(command, args);

  if (!options.quiet) {
    child.stderr.on('data', function(data) {
      process.stderr.write(prefix + data);
    });

    child.stdout.on('data', function(data) {
      process.stdout.write(prefix + data);
    });
  }

  if (typeof callback === 'function') {
    child.on('error', callback);

    child.on('exit', function(code, signal) {
      var error = null;

      if (code !== 0) {
        error = new Error('Exit code ' + code);
      }

      callback(error, signal);
    });
  }

  return child;
}

module.exports = exec;
